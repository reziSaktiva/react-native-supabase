services:
  mongo:
    image: "mongo:7.0"
    command: "--replSet rs0 --bind_ip_all --quiet"
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - "mongo_storage:/data/db"
  mongo-rs-init:
    image: "mongo:7.0"
    depends_on:
      - mongo
    restart: on-failure
    entrypoint:
      - bash
      - "-c"
      - |
        mongosh --host mongo:27017 --eval 'try {
          rs.status().ok && quit(0)
        } catch {
          rs.initiate({
            _id: "rs0",
            version: 1,
            members: [{ _id: 0, host : "mongo:27017" }]
          })
        }'
  powersync:
    image: "journeyapps/powersync-service:latest"
    container_name: powersync
    depends_on:
      - mongo-rs-init
    command:
      - start
      - "-r"
      - unified
    restart: unless-stopped
    environment:
      - 'NODE_OPTIONS="--max-old-space-size=1000"'
      - POWERSYNC_CONFIG_PATH=/home/config/powersync.yaml
      - "PS_DATABASE_TYPE=${PS_DEMO_BACKEND_DATABASE_TYPE:-postgresql}"
      - "PS_DATABASE_URI=${PS_DATABASE_URI:-postgresql://postgres:postgres@localhost:5432/postgres}"
      - "PS_PORT=${PS_PORT:-8080}"
      - "PS_MONGO_URI=${PS_MONGO_URI:-mongodb://mongo:27017/my_db}"
      - "PS_SUPABASE_AUTH=${USE_SUPABASE_AUTH:-false}"
      - "PS_JWKS_URL=${PS_JWKS_URL:-http://localhost:6060/api/auth/keys}"
      - PS_BACKEND_DATABASE_URI=${PS_BACKEND_DATABASE_URI:-postgresql://postgres:postgres@localhost:5432/postgres}
      - PS_SUPABASE_JWT_SECRET=${PS_BACKEND_DATABASE_URI:-eMPSQu3wrHhNx3DDtOCOYwl44siTalA0}
    ports:
      - "${PS_PORT}:${PS_PORT}"
    volumes:
      - "./volumes/config:/home/config"
      - type: bind
        source: ./volumes/config/sync_rules.yaml
        target: /home/config/sync_rules.yaml
        content: |
          bucket_definitions:
            user_lists:
              parameters: select id as list_id from lists where owner_id = request.user_id()
              data:
                - select * from lists where id = bucket.list_id
                - select * from todos where list_id = bucket.list_id
      - type: bind
        source: ./volumes/config/powersync.yaml
        target: /home/config/powersync.yaml
        content: |-
          # yaml-language-server: $schema=../schema/schema.json
          telemetry:
            disable_telemetry_sharing: false

          replication:
            connections:
              - type: !env PS_DATABASE_TYPE
                uri: !env PS_BACKEND_DATABASE_URI
                sslmode: disable  # Options: 'verify-full', 'verify-ca', or 'disable'

          storage:
            type: mongodb
            uri: !env PS_MONGO_URI

          port: !env PS_PORT

          sync_rules:
            path: /home/config/sync_rules.yaml

          client_auth:
            supabase: !env PS_SUPABASE_AUTH
            jwks_uri: !env PS_JWKS_URL
            audience: ["powersync-dev", "powersync"]

          api:
            tokens:
              - use_a_better_token_in_production
    entrypoint:
      - bash
      - "-c"
      - |
        until curl -f http://localhost:${PS_PORT}; do
          echo "Waiting for powersync service to be available..."
          sleep 5
        done
        start -r unified
